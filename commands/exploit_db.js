const { parse } = require("rss-to-json");
const fs = require("fs");
const ms = require("ms");

module.exports = {
  async run(bot) {
    bot.on("/start_exploitdb_feed", (msg) => {
      let chat_id = msg.chat.id;
      fs.readFile("./commands/xdb_id.json", (err, data) => {
        if (err) throw err;
        let db_parsed = JSON.parse(data);
        if (!db_parsed.includes(chat_id)) {
          db_parsed.push(chat_id);
          console.log("New chat added to xpdb feed!", chat_id);
          msg.reply.text("Update feed to this chat started! You are now going to receive updates about the latest ExploitDB Vulnerabilities!");
          fs.writeFile(
            "./commands/xdb_id.json",
            JSON.stringify(db_parsed),
            function (e) {
              if (e) throw e;
              console.log("DB File updated!");
            }
          );
        } else msg.reply.text("Chat update feed alredy started.");
      });
    });

    setInterval(async () => {
      const data = await getXdbFeed();
      if (data == null) return;

      const ids = JSON.parse(fs.readFileSync("./commands/xdb_id.json"));
      const msg_data = generateXdbMessage(data);
      ids.forEach(async (chat) => {
        await bot.sendMessage(chat, msg_data, { parseMode: "HTML" }); //check here
      });
    }, ms("180s"));
  },
};

async function getXdbFeed() {
  const data = await parse("https://www.exploit-db.com/rss.xml").catch((error) => {
    console.log(error)
  });
  let newTimestamp = data.items[0].published;
  let data_old = fs.readFileSync("./commands/data_xdb.txt").toString();
  let oldTimestamp = data_old;

  if(newTimestamp > oldTimestamp) {
      fs.writeFileSync("./commands/data_xdb.txt", data.items[0].published);
      return data;
  }
  return null;
}

function generateXdbMessage(d) {
  const b = (text) => `<b>${text}</b>`;
  const c = (text) => `<code>${text}</code>`;

    let out = `${b("Feed: ")} ${"ExploitDB"}\n\n`;
    out += `${b("Name:")} ${c(d.items[0].title)}\n\n`;
    out += `${b("Description: ")} ${c(d.items[0].description)}\n\n`;
    out += `${b("Ref. Links:")}\n${d.items[0].link}`; 
    return out;
}
